---
phase: 06-combo-data-model
plan: 01
type: execute
---

<objective>
Refactor combo storage from per-key to layer-level with position-based references for adjacency detection.

Purpose: Enable centralized combo management, position-based adjacency detection, and global color assignment for non-adjacent combos.
Output: Updated data model with layer-level combos array, color palette, and adjacency detection function.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/COMBO-VISUALIZATION-PLAN.md

**Prior decisions affecting this phase:**
- Phase 4: Chord as {keys, output} object - structured data easier to parse/render
- Phase 4: Optional combo fields - backward compatible
- v1.1: Multi-combo allowed - same key can be in multiple combos

**Key layout reference (from COMBO-VISUALIZATION-PLAN.md):**
- Array indices 0-17: Main grid (3 rows x 6 columns)
- Array indices 18-23: Thumb cluster
- Adjacency: same side only, orthogonal neighbors in grid, sequential in thumb

**New combo data structure:**
```javascript
layer.combos = [
  {
    keys: [
      { side: "left", index: 5 },
      { side: "right", index: 3 }
    ],
    output: "DELETE"
  }
]
```

@app.js
@layouts.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add combo color palette and adjacency detection functions</name>
  <files>app.js</files>
  <action>
Add after the ZOOM constants (around line 15):

1. Add COMBO_COLORS array with 23 Tailwind colors (from COMBO-VISUALIZATION-PLAN.md):
   - 700 shades: orange, yellow, green, teal, sky, indigo, purple, pink
   - 500 shades: amber, lime, emerald, cyan, blue, violet, fuchsia
   - 300 shades: orange, yellow, green, teal, sky, indigo, purple, pink

2. Add getKeyPosition(side, index) function:
   - If index < 18: return { row: Math.floor(index / 6), col: index % 6, inThumb: false }
   - Else: return { row: 3, col: index - 18, inThumb: true }

3. Add areKeysAdjacent(key1, key2) function:
   - Return false if different sides
   - Both in main grid: adjacent if colDiff === 1 XOR rowDiff === 1 (not diagonal)
   - Both in thumb: adjacent if index difference is 1
   - Main-to-thumb boundary: indices 17 and 18 are adjacent
  </action>
  <verify>Console: typeof COMBO_COLORS === 'object' && COMBO_COLORS.length === 23 && typeof areKeysAdjacent === 'function'</verify>
  <done>COMBO_COLORS has 23 colors, getKeyPosition and areKeysAdjacent functions exist and work correctly</done>
</task>

<task type="auto">
  <name>Task 2: Update DEFAULT_LAYOUTS with combos array per layer</name>
  <files>app.js, layouts.json</files>
  <action>
1. In app.js DEFAULT_LAYOUTS, add empty combos array to each layer object:
   - base: add "combos": [] after "info" object
   - navnum: add "combos": [] after "info" object
   - symbols: add "combos": [] after "info" object
   - system: add "combos": [] after "info" object

2. In layouts.json, add the same combos arrays to each layer.

3. Update the _schema in layouts.json to document the new combos structure:
   Add to layerStructure:
   "combos": "Array of combo definitions [{keys: [{side, index}, {side, index}], output: string}]"

Note: Keep existing per-key chord field for backward compatibility during transition. Phase 7 will handle rendering both.
  </action>
  <verify>In browser console: window.keyboardEditor.layouts().base.combos !== undefined && Array.isArray(window.keyboardEditor.layouts().base.combos)</verify>
  <done>All 4 layers have combos array property, schema documented</done>
</task>

<task type="auto">
  <name>Task 3: Update validation and export to handle combos</name>
  <files>app.js</files>
  <action>
1. Update validateLayoutData() function:
   - After checking left/right arrays, add check for combos:
   - If data[layer].combos exists, verify it's an array
   - Don't require combos (for backward compatibility with old exports)

2. Update exportLayouts() function:
   - The existing spread operator already captures combos
   - Update _schema.layerStructure to include combos description

3. Update loadLayouts() to handle imported layouts without combos:
   - After loading, ensure each layer has combos array (add empty [] if missing)

4. Export new functions via window.keyboardEditor:
   - Add: COMBO_COLORS, getKeyPosition, areKeysAdjacent
  </action>
  <verify>
Test backward compatibility:
1. Export current layout
2. Manually remove combos from JSON
3. Import - should succeed and add empty combos arrays
  </verify>
  <done>Validation accepts layouts with/without combos, export includes combos, old imports get combos array added</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] COMBO_COLORS array has exactly 23 hex color values
- [ ] getKeyPosition(side, 0) returns {row: 0, col: 0, inThumb: false}
- [ ] getKeyPosition(side, 18) returns {row: 3, col: 0, inThumb: true}
- [ ] areKeysAdjacent({side:'left',index:0}, {side:'left',index:1}) returns true
- [ ] areKeysAdjacent({side:'left',index:0}, {side:'left',index:6}) returns true
- [ ] areKeysAdjacent({side:'left',index:0}, {side:'left',index:7}) returns false (diagonal)
- [ ] areKeysAdjacent({side:'left',index:0}, {side:'right',index:1}) returns false (different sides)
- [ ] All 4 layers have combos: [] in DEFAULT_LAYOUTS
- [ ] layouts.json updated with combos arrays and schema
- [ ] Import of old layout (no combos) succeeds
- [ ] Export includes combos in output
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No JavaScript errors in console
- Existing functionality unchanged (key editing, export/import still work)
- Data model ready for Phase 7 rendering
</success_criteria>

<output>
After completion, create `.planning/phases/06-combo-data-model/06-01-SUMMARY.md`:

# Phase 6 Plan 1: Combo Data Model Summary

**[One-line summary of what was accomplished]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `app.js` - Description of changes
- `layouts.json` - Description of changes

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Phase complete, ready for Phase 7: Combo Rendering
</output>
