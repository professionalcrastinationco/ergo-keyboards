# Plan 04-01: Combo Visualization

## Objective
Display all combo types with clear visual indicators. Users can see modifier+key combos as badges, layer-tap behaviors clearly differentiated, and chord combinations with A+B→C notation. Add combo editing fields to sidebar.

## Context
- Phase 3 complete: real-time editing, undo, clear/reset all working
- Current key data model: `{primary, secondary, hold, transparent, accent, highlight}`
- `hold` property already represents layer-tap hold behavior
- `rebuildKeyContent()` renders primary, secondary, and hold indicator elements
- Sidebar has fields for primary, secondary, hold, accent, highlight

**Prior decisions affecting this phase:**
- Phase 1: `rebuildKeyContent()` handles all key content rendering
- Phase 2: Sidebar fields update on key selection via `updateSidebar()`
- Phase 3: `saveUndoState()` called before edits, undo restores full key data

## Tasks

### Task 1: Extend data model for combo types
**Goal:** Add new properties to support modifier combos and chords

**Steps:**
1. Update `_schema` in layouts.json with new properties:
   - `tap`: Explicit tap behavior (for layer-tap keys where primary shows hold)
   - `modifierKey`: Modifier combo display (e.g., "Ctrl+C")
   - `chord`: Chord definition `{keys: ["A","B"], output: "C"}`
2. These are optional fields - existing keys continue to work

**Schema additions:**
```json
"keyProperties": {
  // ... existing ...
  "tap": "Tap behavior label for layer-tap keys (string, optional)",
  "modifierKey": "Modifier+key combo display, e.g. 'Ctrl+C' (string, optional)",
  "chord": "Chord definition {keys: [...], output: '...'} (object, optional)"
}
```

**Verification:**
- Schema documents new properties
- Existing layouts.json remains valid
- No breaking changes

---

### Task 2: Add combo badge CSS styles
**Goal:** Create visual styles for combo badges and indicators

**Steps:**
1. Add `.combo-badge` for modifier+key display (pill-shaped, compact)
2. Add `.layer-tap-indicator` with tap/hold split visualization
3. Add `.chord-notation` for A+B→C display style
4. Use subtle colors that don't overpower existing key styles
5. Badges positioned at top-right of key

**CSS additions:**
```css
/* Combo Badges */
.combo-badge {
    position: absolute;
    top: 2px;
    right: 2px;
    background: rgba(74, 158, 255, 0.3);
    border: 1px solid rgba(74, 158, 255, 0.5);
    border-radius: 8px;
    padding: 1px 5px;
    font-size: 8px;
    color: #4a9eff;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Layer-tap indicator - shows tap on top, hold on bottom */
.layer-tap-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}

.tap-label {
    font-size: 11px;
    color: #fff;
}

.hold-label {
    font-size: 9px;
    color: #888;
    border-top: 1px dashed #444;
    padding-top: 2px;
    width: 100%;
    text-align: center;
}

/* Chord notation */
.chord-notation {
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 7px;
    color: #ffa500;
    white-space: nowrap;
}

.chord-notation .chord-arrow {
    color: #666;
    margin: 0 2px;
}
```

**Verification:**
- Badges visible but not obtrusive
- Colors complement existing theme
- Responsive at different zoom levels

---

### Task 3: Update rebuildKeyContent() for combo rendering
**Goal:** Render new combo types visually on keys

**Steps:**
1. Check for `modifierKey` property - render as `.combo-badge`
2. Check for `tap` + `hold` combo - render as `.layer-tap-wrapper`
3. Check for `chord` property - render as `.chord-notation`
4. Keep existing rendering for backward compatibility
5. Combo elements added to existing key structure

**JavaScript additions:**
```javascript
function rebuildKeyContent(keyEl, keyData) {
    keyEl.innerHTML = '';

    // Modifier combo badge (top-right)
    if (keyData.modifierKey) {
        const badge = document.createElement('div');
        badge.className = 'combo-badge';
        badge.textContent = keyData.modifierKey;
        keyEl.appendChild(badge);
    }

    // Layer-tap: explicit tap + hold rendering
    if (keyData.tap && keyData.hold) {
        const wrapper = document.createElement('div');
        wrapper.className = 'layer-tap-wrapper';

        const tapLabel = document.createElement('div');
        tapLabel.className = 'tap-label';
        tapLabel.textContent = keyData.tap;
        wrapper.appendChild(tapLabel);

        const holdLabel = document.createElement('div');
        holdLabel.className = 'hold-label';
        holdLabel.textContent = keyData.hold;
        wrapper.appendChild(holdLabel);

        keyEl.appendChild(wrapper);
    } else {
        // Standard rendering (existing logic)
        const primary = document.createElement('div');
        primary.className = 'primary';
        primary.textContent = keyData.primary || '';
        keyEl.appendChild(primary);

        if (keyData.secondary) {
            const secondary = document.createElement('div');
            secondary.className = 'secondary';
            secondary.textContent = keyData.secondary;
            keyEl.appendChild(secondary);
        }

        if (keyData.hold) {
            const hold = document.createElement('div');
            hold.className = 'hold-indicator';
            hold.textContent = keyData.hold;
            keyEl.appendChild(hold);
        }
    }

    // Chord notation (bottom)
    if (keyData.chord && keyData.chord.keys && keyData.chord.output) {
        const chord = document.createElement('div');
        chord.className = 'chord-notation';
        chord.innerHTML = keyData.chord.keys.join('+') +
            '<span class="chord-arrow">→</span>' +
            keyData.chord.output;
        keyEl.appendChild(chord);
    }
}
```

**Verification:**
- Keys with modifierKey show badge
- Keys with tap+hold show split layout
- Keys with chord show notation
- Existing keys render unchanged

---

### Task 4: Add combo fields to sidebar
**Goal:** Enable editing of new combo properties in sidebar

**Steps:**
1. Add "Combo Properties" section after existing fields
2. Add fields: Tap Label, Modifier Combo, Chord Keys, Chord Output
3. Wire input handlers following existing pattern
4. Update `updateSidebar()` to populate combo fields
5. Update `clearSelectedKey()` to include new properties

**HTML additions:**
```html
<div class="field-section">
    <h3 class="section-title">Combo Properties</h3>
    <div class="field-group">
        <label for="field-tap">Tap Label</label>
        <input type="text" id="field-tap" placeholder="Layer-tap tap behavior">
    </div>
    <div class="field-group">
        <label for="field-modifier-key">Modifier Combo</label>
        <input type="text" id="field-modifier-key" placeholder="e.g., Ctrl+C">
    </div>
    <div class="field-group">
        <label for="field-chord-keys">Chord Keys</label>
        <input type="text" id="field-chord-keys" placeholder="e.g., A+B">
    </div>
    <div class="field-group">
        <label for="field-chord-output">Chord Output</label>
        <input type="text" id="field-chord-output" placeholder="e.g., C">
    </div>
</div>
```

**JavaScript additions:**
```javascript
// In updateSidebar() - add after existing field population:
document.getElementById('field-tap').value = keyData.tap || '';
document.getElementById('field-modifier-key').value = keyData.modifierKey || '';
document.getElementById('field-chord-keys').value =
    keyData.chord ? keyData.chord.keys.join('+') : '';
document.getElementById('field-chord-output').value =
    keyData.chord ? keyData.chord.output : '';

// In initSidebarListeners() - add handlers:
document.getElementById('field-tap').addEventListener('input', (e) => {
    if (!selectedKey) return;
    saveUndoState();
    const { layer, side, index } = selectedKey;
    layouts[layer][side][index].tap = e.target.value || undefined;
    updateKey(layer, side, index);
    getKeyElement(layer, side, index).classList.add('selected');
});

document.getElementById('field-modifier-key').addEventListener('input', (e) => {
    if (!selectedKey) return;
    saveUndoState();
    const { layer, side, index } = selectedKey;
    layouts[layer][side][index].modifierKey = e.target.value || undefined;
    updateKey(layer, side, index);
    getKeyElement(layer, side, index).classList.add('selected');
});

// Chord fields need to create/update chord object
document.getElementById('field-chord-keys').addEventListener('input', (e) => {
    if (!selectedKey) return;
    saveUndoState();
    const { layer, side, index } = selectedKey;
    const keyData = layouts[layer][side][index];
    const keys = e.target.value ? e.target.value.split('+').map(k => k.trim()) : null;
    if (keys && keys.length > 0) {
        keyData.chord = keyData.chord || {};
        keyData.chord.keys = keys;
    } else if (keyData.chord) {
        delete keyData.chord.keys;
        if (!keyData.chord.output) delete keyData.chord;
    }
    updateKey(layer, side, index);
    getKeyElement(layer, side, index).classList.add('selected');
});

document.getElementById('field-chord-output').addEventListener('input', (e) => {
    if (!selectedKey) return;
    saveUndoState();
    const { layer, side, index } = selectedKey;
    const keyData = layouts[layer][side][index];
    if (e.target.value) {
        keyData.chord = keyData.chord || {};
        keyData.chord.output = e.target.value;
    } else if (keyData.chord) {
        delete keyData.chord.output;
        if (!keyData.chord.keys) delete keyData.chord;
    }
    updateKey(layer, side, index);
    getKeyElement(layer, side, index).classList.add('selected');
});

// In clearSelectedKey() - update cleared state:
layouts[layer][side][index] = {
    primary: '',
    secondary: '',
    hold: '',
    tap: '',
    modifierKey: '',
    chord: null,
    accent: false,
    highlight: false
};
```

**Verification:**
- Combo fields visible in sidebar
- Editing tap/modifierKey updates key display
- Editing chord keys/output updates chord notation
- Clear key resets combo fields too

---

### Task 5: Add CSS for section title styling
**Goal:** Style the new Combo Properties section header

**Steps:**
1. Add `.section-title` class for sidebar section headers
2. Add `.field-section` for grouping related fields
3. Style matches existing dark theme

**CSS additions:**
```css
.field-section {
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid #3d3d5c;
}

.section-title {
    color: #888;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
}
```

**Verification:**
- Section visually separated
- Title styling matches theme
- Good visual hierarchy

---

## Success Criteria

- [ ] Keys with `modifierKey` show badge (e.g., "Ctrl+C")
- [ ] Keys with `tap` + `hold` show layer-tap split view
- [ ] Keys with `chord` show A+B→C notation
- [ ] Combo Properties section visible in sidebar
- [ ] Editing combo fields updates key display instantly
- [ ] Clear Key resets combo properties
- [ ] Undo works for combo edits
- [ ] Existing keys without new properties render unchanged
- [ ] No console errors
- [ ] Schema updated with new properties

## Files Modified

- `layouts.json` - Update `_schema` with new property definitions
- `styles.css` - Add combo badge, layer-tap, chord, and section styles
- `app.js` - Update `rebuildKeyContent()`, `updateSidebar()`, `initSidebarListeners()`, `clearSelectedKey()`
- `index.html` - Add combo fields section to sidebar

## Notes

- New properties are optional - backward compatible with existing data
- Chord object structure: `{keys: ["A", "B"], output: "C"}`
- Chord keys stored as array but displayed/edited as "A+B" string
- Layer-tap uses `tap` for tap behavior instead of overloading `primary`
- Position key relatively to enable absolute positioned badges
