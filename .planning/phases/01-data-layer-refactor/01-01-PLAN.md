# Plan 01-01: Data Layer Refactor

## Objective
Extract the monolithic index.html into separate files (CSS, JS, JSON) and refactor rendering to support dynamic updates. This creates the foundation for all future editing functionality.

## Context
- Current state: Single 960-line HTML file with inline CSS (lines 7-402), HTML (404-452), and JavaScript (454-958)
- Layout data hardcoded in `layouts` object (lines 456-723, ~270 lines)
- Key data model: `{primary, secondary, hold, transparent, accent, highlight, rotated}`
- Rendering functions: `createKey()` (line 779), `renderLayout()` (line 832)

## Tasks

### Task 1: Extract CSS to styles.css
**Goal:** Move all inline styles to external stylesheet

**Steps:**
1. Create `styles.css` in project root
2. Copy lines 8-401 (everything inside `<style>` tags) to styles.css
3. Update index.html to link stylesheet: `<link rel="stylesheet" href="styles.css">`
4. Remove `<style>` block from index.html
5. Verify visual appearance unchanged

**Verification:**
- Open index.html in browser
- All 4 layers render correctly
- Zoom controls work
- Hover states and animations work

---

### Task 2: Extract layouts to layouts.json
**Goal:** Move keyboard data to external JSON file for future editability

**Steps:**
1. Create `layouts.json` in project root
2. Export `layouts` object structure to JSON format
3. Add JSON schema documentation comment at top
4. Structure: `{ "base": {...}, "navnum": {...}, "symbols": {...}, "system": {...} }`
5. Each layer has: `left[]`, `right[]`, `info{title, description}`

**JSON Schema:**
```json
{
  "layerName": {
    "left": [
      { "primary": "string", "secondary": "string?", "hold": "string?", "transparent": "boolean?", "accent": "boolean?", "highlight": "boolean?", "rotated": "string?" }
    ],
    "right": [...],
    "info": { "title": "string", "description": "string" }
  }
}
```

**Verification:**
- JSON validates (no syntax errors)
- All 4 layers present
- Key counts match original (24 left, 24 right per layer)

---

### Task 3: Extract JavaScript to app.js
**Goal:** Move all JavaScript to external file, add JSON loading

**Steps:**
1. Create `app.js` in project root
2. Move all JavaScript from `<script>` block to app.js
3. Replace hardcoded `layouts` object with `let layouts = null;`
4. Add async `loadLayouts()` function to fetch layouts.json
5. Update initialization to wait for JSON load before rendering
6. Add `<script src="app.js"></script>` to index.html (before `</body>`)
7. Remove inline `<script>` block from index.html

**Key changes to app.js:**
```javascript
let layouts = null;

async function loadLayouts() {
    const response = await fetch('layouts.json');
    layouts = await response.json();
}

async function init() {
    await loadLayouts();
    renderLayout('base');
    setZoom(100);
}

// Call init when DOM ready
document.addEventListener('DOMContentLoaded', init);
```

**Verification:**
- App loads without errors
- All layers render correctly
- Layer switching works
- Keyboard shortcuts work (1-4 for layers, +/- for zoom)

---

### Task 4: Refactor rendering for single-key updates
**Goal:** Enable updating individual keys without full re-render

**Steps:**
1. Add `data-layer`, `data-side`, `data-index` attributes to each key element
2. Create `updateKey(layer, side, index)` function that:
   - Finds the key element by attributes
   - Gets updated data from `layouts[layer][side][index]`
   - Updates the key's innerHTML and classes
3. Create `getKeyElement(layer, side, index)` helper function
4. Keep `renderLayout()` for full redraws, use `updateKey()` for edits

**New function signature:**
```javascript
function updateKey(layer, side, index) {
    const keyEl = getKeyElement(layer, side, index);
    if (!keyEl) return;

    const keyData = layouts[layer][side][index];
    // Re-create key content based on keyData
    rebuildKeyContent(keyEl, keyData);
}
```

**Verification:**
- Keys have data attributes when inspected
- Can call `updateKey('base', 'left', 1)` in console
- Visual update happens without full page re-render

---

### Task 5: Clean up index.html
**Goal:** Slim HTML file with only structure and external references

**Steps:**
1. Verify all external files work correctly
2. Ensure index.html only contains:
   - DOCTYPE and html/head/body structure
   - Meta tags and title
   - Link to styles.css
   - HTML structure (container, tabs, keyboard layout, legend, footer)
   - Script tag for app.js
3. Remove any leftover inline code
4. Add comment noting this is the main entry point

**Final index.html structure (~50 lines):**
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZMK Keyboard Layout Editor</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Container, tabs, keyboard, legend, footer -->
    <script src="app.js"></script>
</body>
</html>
```

**Verification:**
- index.html is clean and readable
- All functionality still works
- No console errors
- File loads properly when served locally

---

## Success Criteria

- [ ] styles.css contains all CSS (~395 lines)
- [ ] layouts.json contains all keyboard data (valid JSON)
- [ ] app.js contains all JavaScript with JSON loading
- [ ] index.html is clean HTML structure only (~50 lines)
- [ ] All 4 layers render correctly
- [ ] Zoom controls work (buttons, slider, keyboard shortcuts, scroll wheel)
- [ ] Layer switching works (tabs and keyboard shortcuts 1-4)
- [ ] `updateKey()` function exists and works for single-key updates
- [ ] No console errors
- [ ] Works when served from local file system

## Files Created/Modified

**Created:**
- `styles.css` - All CSS styles
- `layouts.json` - Keyboard layout data
- `app.js` - All JavaScript logic

**Modified:**
- `index.html` - Stripped to HTML structure only

## Notes

- Keep all existing functionality working throughout
- Test each task before moving to next
- The `updateKey()` function is critical for Phase 2+ editing features
- JSON format enables future LocalStorage save/load and file export/import
