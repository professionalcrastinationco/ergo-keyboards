# Plan 03-01: Real-time Editing

## Objective
Enable live editing of key properties with instant visual feedback. Users can modify any field in the sidebar and see the key update immediately on the keyboard. Includes clear/reset and single-level undo functionality.

## Context
- Phase 2 complete: sidebar displays selected key properties in read-only form
- `updateKey(layer, side, index)` function ready for single-key updates
- `layouts` object holds all key data in memory
- `updateSidebar()` populates fields from `layouts` data
- Key data model: `{primary, secondary, hold, transparent, accent, highlight}`

**Prior decisions affecting this phase:**
- Phase 1: Data attributes on keys enable efficient `updateKey()` lookups
- Phase 2: Sidebar has input fields already wired (`field-primary`, `field-secondary`, etc.)

## Tasks

### Task 1: Add input event handlers for live editing
**Goal:** Wire sidebar fields to update layouts data and key display in real-time

**Steps:**
1. Add `input` event listeners to text fields (primary, secondary, hold)
2. Add `change` event listeners to checkboxes (accent, highlight)
3. On input, update `layouts[layer][side][index]` with new value
4. Call `updateKey()` to refresh the key's visual display
5. Preserve selected state on key after update

**JavaScript additions:**
```javascript
function initSidebarListeners() {
    // Text fields - update on input for instant feedback
    document.getElementById('field-primary').addEventListener('input', (e) => {
        if (!selectedKey) return;
        const { layer, side, index } = selectedKey;
        layouts[layer][side][index].primary = e.target.value;
        updateKey(layer, side, index);
        // Re-add selected class (updateKey resets classes)
        getKeyElement(layer, side, index).classList.add('selected');
    });

    // Similar for field-secondary, field-hold, field-accent, field-highlight
}
```

**Verification:**
- Select a key, type in primary field, key label updates immediately
- Change accent checkbox, key background changes immediately
- Selected state remains on key after edits

---

### Task 2: Add clear key and reset to default functionality
**Goal:** Allow users to clear a key or reset it to original loaded values

**Steps:**
1. Store original layouts on load as `originalLayouts` (deep copy)
2. Add "Clear Key" button to sidebar - sets all properties to empty/false
3. Add "Reset Key" button to sidebar - restores from `originalLayouts`
4. Update HTML with buttons in key-fields section
5. Update sidebar display after clear/reset

**HTML additions:**
```html
<div class="sidebar-actions">
    <button id="btn-clear-key" class="sidebar-btn">Clear Key</button>
    <button id="btn-reset-key" class="sidebar-btn secondary">Reset Key</button>
</div>
```

**JavaScript additions:**
```javascript
let originalLayouts = null;

async function loadLayouts() {
    // ... existing code ...
    // Store deep copy of original layouts
    originalLayouts = JSON.parse(JSON.stringify(layouts));
}

function clearSelectedKey() {
    if (!selectedKey) return;
    const { layer, side, index } = selectedKey;
    layouts[layer][side][index] = {
        primary: '',
        secondary: '',
        hold: '',
        accent: false,
        highlight: false
    };
    updateKey(layer, side, index);
    getKeyElement(layer, side, index).classList.add('selected');
    updateSidebar();
}

function resetSelectedKey() {
    if (!selectedKey) return;
    const { layer, side, index } = selectedKey;
    layouts[layer][side][index] = JSON.parse(
        JSON.stringify(originalLayouts[layer][side][index])
    );
    updateKey(layer, side, index);
    getKeyElement(layer, side, index).classList.add('selected');
    updateSidebar();
}
```

**Verification:**
- Click "Clear Key" - key shows blank, sidebar fields empty
- Click "Reset Key" - key restores original label and properties
- Both buttons update sidebar display correctly

---

### Task 3: Add single-level undo functionality
**Goal:** Allow users to undo the last change to any key

**Steps:**
1. Create `undoStack` array to store previous states
2. Before each edit, push current key state to stack (max 1 item for single-level)
3. Add "Undo" button to sidebar (disabled when stack empty)
4. On undo, pop state and restore key
5. Update button disabled state after each action

**HTML additions:**
```html
<button id="btn-undo" class="sidebar-btn" disabled>Undo</button>
```

**JavaScript additions:**
```javascript
let lastKeyState = null; // Single-level undo

function saveUndoState() {
    if (!selectedKey) return;
    const { layer, side, index } = selectedKey;
    lastKeyState = {
        layer, side, index,
        data: JSON.parse(JSON.stringify(layouts[layer][side][index]))
    };
    updateUndoButton();
}

function undo() {
    if (!lastKeyState) return;
    const { layer, side, index, data } = lastKeyState;
    layouts[layer][side][index] = data;
    updateKey(layer, side, index);

    // If this key is still selected, update sidebar
    if (selectedKey && selectedKey.layer === layer &&
        selectedKey.side === side && selectedKey.index === index) {
        getKeyElement(layer, side, index).classList.add('selected');
        updateSidebar();
    }

    lastKeyState = null;
    updateUndoButton();
}

function updateUndoButton() {
    document.getElementById('btn-undo').disabled = !lastKeyState;
}
```

**Verification:**
- Edit a key property
- Click "Undo" - key reverts to previous state
- Undo button disabled when no undo available
- Undo works across key selections (edit key A, select key B, undo restores key A)

---

## Success Criteria

- [ ] Typing in any text field updates key display instantly
- [ ] Checking/unchecking accent/highlight updates key immediately
- [ ] "Clear Key" sets all fields to empty/false
- [ ] "Reset Key" restores original loaded values
- [ ] "Undo" reverts the last change (single-level)
- [ ] Selected state preserved after edits
- [ ] No console errors
- [ ] `window.keyboardEditor` API extended with new functions

## Files Modified

- `index.html` - Add Clear, Reset, Undo buttons to sidebar
- `styles.css` - Add button styles
- `app.js` - Add editing logic, undo stack, originalLayouts storage

## Notes

- Single-level undo is intentional per roadmap - keeps implementation simple
- Changes are in-memory only - Phase 5 adds persistence
- Deep copy via `JSON.parse(JSON.stringify())` is fine for this data size
- Preserve selected class manually after `updateKey()` since it resets classes
