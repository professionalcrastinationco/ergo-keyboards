# Plan 05-01: Persistence & Export

## Objective
Save work automatically via LocalStorage and enable JSON file import/export. Users can persist edits between sessions, export layouts to share, import external layouts, and reset to defaults.

## Context
- Phase 4 complete: all combo types editable and displayed
- `layouts` holds current data in memory, `originalLayouts` stores initial state
- `loadLayouts()` fetches from `layouts.json` on startup
- All edits update `layouts` object in memory but don't persist
- LocalStorage key: `keyboardEditor_layouts`

**Prior decisions affecting this phase:**
- Phase 1: JSON schema documented in `_schema` section of layouts.json
- Phase 3: `originalLayouts` deep copy available for reset reference
- Phase 4: All key properties (including combos) stored in layouts object

## Tasks

### Task 1: Add LocalStorage auto-save
**Goal:** Automatically save layouts to LocalStorage after each edit

**Steps:**
1. Create `saveToLocalStorage()` function that saves `layouts` to LocalStorage
2. Call `saveToLocalStorage()` after each edit operation
3. Create `loadFromLocalStorage()` function to retrieve saved data
4. Modify `loadLayouts()` to check LocalStorage first, fall back to fetch
5. Show indicator when using saved data vs default

**JavaScript additions:**
```javascript
const STORAGE_KEY = 'keyboardEditor_layouts';

/**
 * Save current layouts to LocalStorage
 */
function saveToLocalStorage() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(layouts));
        updateSaveIndicator(true);
    } catch (error) {
        console.warn('Failed to save to LocalStorage:', error);
    }
}

/**
 * Load layouts from LocalStorage if available
 * @returns {Object|null} Saved layouts or null
 */
function loadFromLocalStorage() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            return JSON.parse(saved);
        }
    } catch (error) {
        console.warn('Failed to load from LocalStorage:', error);
    }
    return null;
}

/**
 * Update save indicator in UI
 * @param {boolean} hasSaved - Whether there's saved data
 */
function updateSaveIndicator(hasSaved) {
    const indicator = document.getElementById('save-indicator');
    if (indicator) {
        indicator.textContent = hasSaved ? 'Saved' : 'Default';
        indicator.className = 'save-indicator ' + (hasSaved ? 'saved' : 'default');
    }
}
```

**Modify loadLayouts():**
```javascript
async function loadLayouts() {
    // Try LocalStorage first
    const savedLayouts = loadFromLocalStorage();
    if (savedLayouts) {
        layouts = savedLayouts;
        // Still fetch original for reset functionality
        try {
            const response = await fetch('layouts.json');
            const data = await response.json();
            const { _schema, ...layerData } = data;
            originalLayouts = layerData;
        } catch (error) {
            originalLayouts = JSON.parse(JSON.stringify(layouts));
        }
        updateSaveIndicator(true);
        return;
    }

    // Fall back to fetch from file
    // ... existing fetch logic ...
    updateSaveIndicator(false);
}
```

**Add saveToLocalStorage() calls in initSidebarListeners() after each edit.**

**Verification:**
- Edit a key, refresh page → edit persists
- Save indicator shows "Saved" after edits
- Console shows no errors

---

### Task 2: Add Export button and functionality
**Goal:** Download current layouts as JSON file

**Steps:**
1. Add Export button to sidebar actions area
2. Create `exportLayouts()` function
3. Generate JSON with schema and layer data
4. Trigger browser download with timestamp filename
5. Style button to match existing UI

**HTML additions:**
```html
<div class="field-section">
    <h3 class="section-title">File Operations</h3>
    <div class="file-actions">
        <button id="btn-export" class="sidebar-btn primary">Export JSON</button>
        <button id="btn-import" class="sidebar-btn">Import JSON</button>
        <input type="file" id="file-import" accept=".json" style="display: none;">
        <button id="btn-reset-all" class="sidebar-btn danger">Reset to Default</button>
    </div>
</div>
```

**JavaScript additions:**
```javascript
/**
 * Export current layouts as JSON file download
 */
function exportLayouts() {
    // Rebuild full JSON with schema
    const exportData = {
        _schema: {
            description: "ZMK Keyboard Layout Editor - Layout Data Schema",
            version: "1.0.0",
            keyProperties: {
                primary: "Main key label (string, required)",
                secondary: "Secondary label below primary (string, optional)",
                hold: "Hold modifier indicator (string, optional)",
                transparent: "Invisible/placeholder key (boolean, optional)",
                accent: "Special key styling (boolean, optional)",
                highlight: "Highlighted key with border (boolean, optional)",
                tap: "Tap behavior label for layer-tap keys (string, optional)",
                modifierKey: "Modifier+key combo display (string, optional)",
                chord: "Chord definition {keys: [...], output: '...'} (object, optional)"
            },
            layerStructure: {
                left: "Array of 24 keys for left half (18 main + 6 thumb area)",
                right: "Array of 24 keys for right half (18 main + 6 thumb area)",
                info: "Layer metadata with title and description"
            }
        },
        ...layouts
    };

    const json = JSON.stringify(exportData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const timestamp = new Date().toISOString().slice(0, 10);
    const filename = `keyboard-layout-${timestamp}.json`;

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
```

**Verification:**
- Click Export → JSON file downloads
- Downloaded file contains all layers and schema
- File is valid JSON when opened

---

### Task 3: Add Import functionality with validation
**Goal:** Import layouts from JSON file with schema validation

**Steps:**
1. Wire file input to import handler
2. Create `importLayouts(file)` function
3. Validate JSON structure before applying
4. Check for required layers (base, navnum, symbols, system)
5. Show error message if validation fails
6. Apply imported data and re-render

**JavaScript additions:**
```javascript
/**
 * Validate imported layout data structure
 * @param {Object} data - Parsed JSON data
 * @returns {Object} {valid: boolean, error: string|null}
 */
function validateLayoutData(data) {
    const requiredLayers = ['base', 'navnum', 'symbols', 'system'];

    for (const layer of requiredLayers) {
        if (!data[layer]) {
            return { valid: false, error: `Missing required layer: ${layer}` };
        }
        if (!data[layer].left || !Array.isArray(data[layer].left)) {
            return { valid: false, error: `Layer ${layer} missing 'left' array` };
        }
        if (!data[layer].right || !Array.isArray(data[layer].right)) {
            return { valid: false, error: `Layer ${layer} missing 'right' array` };
        }
        if (data[layer].left.length !== 24 || data[layer].right.length !== 24) {
            return { valid: false, error: `Layer ${layer} must have 24 keys per side` };
        }
        if (!data[layer].info || !data[layer].info.title) {
            return { valid: false, error: `Layer ${layer} missing info.title` };
        }
    }

    return { valid: true, error: null };
}

/**
 * Import layouts from file
 * @param {File} file - JSON file to import
 */
async function importLayouts(file) {
    try {
        const text = await file.text();
        const data = JSON.parse(text);

        // Remove schema if present
        const { _schema, ...layerData } = data;

        // Validate structure
        const validation = validateLayoutData(layerData);
        if (!validation.valid) {
            showNotification(validation.error, 'error');
            return;
        }

        // Apply imported data
        layouts = layerData;
        saveToLocalStorage();
        renderLayout(currentLayer);
        deselectKey();

        showNotification('Layout imported successfully', 'success');
    } catch (error) {
        showNotification('Invalid JSON file: ' + error.message, 'error');
    }
}

/**
 * Show notification message
 * @param {string} message - Message to display
 * @param {string} type - 'success' or 'error'
 */
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
```

**Verification:**
- Import valid JSON → layouts update, notification shows success
- Import invalid JSON → error notification, layouts unchanged
- Import file missing layer → specific error message

---

### Task 4: Add Reset to Default functionality
**Goal:** Clear saved data and restore original layouts

**Steps:**
1. Create `resetToDefault()` function
2. Clear LocalStorage
3. Restore `layouts` from `originalLayouts`
4. Re-render current layer
5. Show confirmation notification
6. Add confirmation dialog before reset

**JavaScript additions:**
```javascript
/**
 * Reset layouts to original default state
 */
function resetToDefault() {
    if (!confirm('Reset all layouts to default? This will discard all your changes.')) {
        return;
    }

    // Clear LocalStorage
    localStorage.removeItem(STORAGE_KEY);

    // Restore from original
    layouts = JSON.parse(JSON.stringify(originalLayouts));

    // Re-render
    renderLayout(currentLayer);
    deselectKey();
    updateSaveIndicator(false);

    showNotification('Reset to default layout', 'success');
}
```

**Verification:**
- Make edits, click Reset → edits discarded
- Confirmation dialog appears before reset
- Save indicator shows "Default" after reset
- Refresh page → default layout loads

---

### Task 5: Add CSS styles for file operations UI
**Goal:** Style new buttons and notifications

**Steps:**
1. Style file actions section
2. Add primary button style (blue, for Export)
3. Add danger button style (red, for Reset)
4. Style notification popups
5. Style save indicator badge

**CSS additions:**
```css
/* File Actions */
.file-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.sidebar-btn.primary {
    background: #4a9eff;
    color: #fff;
}

.sidebar-btn.primary:hover {
    background: #3a8eef;
}

.sidebar-btn.danger {
    background: transparent;
    border-color: #ff6b6b;
    color: #ff6b6b;
}

.sidebar-btn.danger:hover {
    background: rgba(255, 107, 107, 0.1);
}

/* Save Indicator */
.save-indicator {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 8px;
}

.save-indicator.saved {
    background: rgba(74, 255, 128, 0.2);
    color: #4aff80;
}

.save-indicator.default {
    background: rgba(150, 150, 150, 0.2);
    color: #999;
}

/* Notifications */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    animation: slideIn 0.3s ease;
}

.notification.success {
    background: rgba(74, 255, 128, 0.9);
    color: #1a1a2e;
}

.notification.error {
    background: rgba(255, 107, 107, 0.9);
    color: #fff;
}

.notification.fade-out {
    animation: fadeOut 0.3s ease forwards;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}
```

**Verification:**
- Export button is blue, prominent
- Reset button is red, warns of danger
- Notifications slide in from right
- Save indicator visible in sidebar header

---

### Task 6: Wire up event listeners
**Goal:** Connect all new buttons to their handlers

**Steps:**
1. Add listener for Export button
2. Add listener for Import button (triggers file input)
3. Add listener for file input change (handles file selection)
4. Add listener for Reset button
5. Add save indicator to sidebar header HTML

**HTML modification (sidebar header):**
```html
<div class="sidebar-header">
    <h2>Key Editor <span class="save-indicator" id="save-indicator">Default</span></h2>
    <span class="selected-position" id="selected-position">No key selected</span>
</div>
```

**JavaScript additions to initSidebarListeners():**
```javascript
// File operations
document.getElementById('btn-export').addEventListener('click', exportLayouts);

document.getElementById('btn-import').addEventListener('click', () => {
    document.getElementById('file-import').click();
});

document.getElementById('file-import').addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        importLayouts(e.target.files[0]);
        e.target.value = ''; // Reset for re-import of same file
    }
});

document.getElementById('btn-reset-all').addEventListener('click', resetToDefault);
```

**Verification:**
- All buttons respond to clicks
- Import opens file picker
- Selected file triggers import
- Reset shows confirmation

---

## Success Criteria

- [ ] Edits persist in LocalStorage between sessions
- [ ] Save indicator shows "Saved" after edits
- [ ] Export downloads valid JSON file with schema
- [ ] Import accepts valid JSON files
- [ ] Import rejects invalid JSON with specific error
- [ ] Reset to Default clears saved data and restores original
- [ ] Reset shows confirmation before proceeding
- [ ] Notifications display for import/reset operations
- [ ] No console errors
- [ ] Works fully offline after initial load

## Files Modified

- `index.html` - Add file operations section, save indicator
- `styles.css` - Add button styles, notification styles, save indicator
- `app.js` - Add persistence functions, import/export, validation

## Notes

- LocalStorage has ~5MB limit, more than enough for layout data
- File download uses blob URL technique for cross-browser support
- Validation checks structure but not individual key values
- Schema version embedded in exports for future compatibility
- Notifications auto-dismiss after 3 seconds
