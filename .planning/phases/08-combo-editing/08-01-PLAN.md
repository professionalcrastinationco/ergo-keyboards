---
phase: 08-combo-editing
plan: 01
type: execute
---

<objective>
Add combo creation mode (click two keys, enter output), sidebar combo list with delete, and ESC/click-outside to exit.

Purpose: Enable users to create and manage layer-level combos through intuitive UI interactions.
Output: Complete combo editing workflow - create via key clicks, view in sidebar list, delete by clicking.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/COMBO-VISUALIZATION-PLAN.md

**Prior decisions affecting this phase:**
- v1.1: Exit combo mode via ESC or click outside
- v1.1: Click two keys mode (enter mode, click 2 keys, type output)
- Phase 6: layer.combos = [{keys: [{side, index}, ...], output}]
- Phase 7: renderCombos() handles visualization

@app.js
@styles.css
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add combo mode state and UI elements to HTML</name>
  <files>index.html, app.js</files>
  <action>
1. In index.html, add combo section after the "Combo Properties" section (around line 88):
```html
<div class="field-section" id="combo-section">
    <h3 class="section-title">Layer Combos</h3>
    <button id="btn-add-combo" class="sidebar-btn primary">+ Add Combo</button>
    <div id="combo-mode-status" class="combo-mode-status" style="display: none;">
        <span id="combo-mode-text">Click first key...</span>
        <button id="btn-cancel-combo" class="sidebar-btn secondary">Cancel</button>
    </div>
    <div id="combo-list" class="combo-list"></div>
</div>
```

2. In app.js, add combo mode state after the existing state variables (around line 12):
```javascript
let comboMode = null; // null | {step: 'first'|'second', firstKey: {side, index}}
```
  </action>
  <verify>HTML elements exist, comboMode variable declared</verify>
  <done>Combo section added to sidebar, comboMode state variable exists</done>
</task>

<task type="auto">
  <name>Task 2: Add CSS for combo mode and combo list</name>
  <files>styles.css</files>
  <action>
Add after the existing combo badge styles:

```css
/* Combo mode overlay effect */
.combo-mode .key:not(.combo-selected) {
    opacity: 0.4;
    pointer-events: auto;
}

.combo-mode .key.combo-selected {
    box-shadow: 0 0 0 3px #4aff80;
    opacity: 1;
}

.combo-mode .key:hover:not(.combo-selected) {
    opacity: 0.7;
}

/* Combo mode status */
.combo-mode-status {
    background: rgba(74, 158, 255, 0.1);
    border: 1px solid #4a9eff;
    border-radius: 6px;
    padding: 12px;
    margin: 12px 0;
    text-align: center;
}

.combo-mode-status span {
    display: block;
    color: #4a9eff;
    font-size: 13px;
    margin-bottom: 8px;
}

/* Combo list */
.combo-list {
    margin-top: 12px;
}

.combo-list-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    background: #2d2d44;
    border-radius: 6px;
    margin-bottom: 6px;
    font-size: 12px;
}

.combo-list-item .combo-keys {
    color: #aaa;
}

.combo-list-item .combo-output {
    color: #4aff80;
    font-weight: 600;
}

.combo-list-item .combo-delete {
    background: transparent;
    border: none;
    color: #ff6b6b;
    cursor: pointer;
    font-size: 14px;
    padding: 2px 6px;
    border-radius: 4px;
}

.combo-list-item .combo-delete:hover {
    background: rgba(255, 107, 107, 0.2);
}

.combo-list-empty {
    color: #666;
    font-size: 12px;
    text-align: center;
    padding: 12px;
}
```
  </action>
  <verify>CSS classes added for combo-mode, combo-list-item, etc.</verify>
  <done>CSS styles for combo mode UI and list display</done>
</task>

<task type="auto">
  <name>Task 3: Add combo mode functions</name>
  <files>app.js</files>
  <action>
Add after renderNonAdjacentComboBadges():

```javascript
/**
 * Enter combo creation mode
 */
function enterComboMode() {
    comboMode = { step: 'first', firstKey: null };
    document.getElementById('keyboard-container').classList.add('combo-mode');
    document.getElementById('combo-mode-status').style.display = 'block';
    document.getElementById('combo-mode-text').textContent = 'Click first key...';
    document.getElementById('btn-add-combo').style.display = 'none';
    deselectKey(); // Clear any key selection
}

/**
 * Exit combo creation mode
 */
function exitComboMode() {
    comboMode = null;
    document.getElementById('keyboard-container').classList.remove('combo-mode');
    document.getElementById('combo-mode-status').style.display = 'none';
    document.getElementById('btn-add-combo').style.display = 'block';
    // Clear combo-selected class from all keys
    document.querySelectorAll('.key.combo-selected').forEach(el => {
        el.classList.remove('combo-selected');
    });
}

/**
 * Handle key click during combo mode
 * @param {string} side - 'left' or 'right'
 * @param {number} index - Key index
 */
function handleComboModeClick(side, index) {
    if (!comboMode) return;

    const keyEl = getKeyElement(currentLayer, side, index);
    if (!keyEl) return;

    if (comboMode.step === 'first') {
        // First key selected
        comboMode.firstKey = { side, index };
        comboMode.step = 'second';
        keyEl.classList.add('combo-selected');
        document.getElementById('combo-mode-text').textContent = 'Click second key...';
    } else if (comboMode.step === 'second') {
        // Second key selected - prompt for output
        const secondKey = { side, index };

        // Don't allow same key
        if (comboMode.firstKey.side === side && comboMode.firstKey.index === index) {
            return;
        }

        keyEl.classList.add('combo-selected');

        // Prompt for output
        const output = prompt('Enter combo output:');
        if (output && output.trim()) {
            addCombo(comboMode.firstKey, secondKey, output.trim());
        }
        exitComboMode();
    }
}

/**
 * Add a new combo to the current layer
 * @param {Object} key1 - {side, index}
 * @param {Object} key2 - {side, index}
 * @param {string} output - Combo output
 */
function addCombo(key1, key2, output) {
    if (!layouts[currentLayer].combos) {
        layouts[currentLayer].combos = [];
    }
    layouts[currentLayer].combos.push({
        keys: [key1, key2],
        output: output
    });
    saveToLocalStorage();
    renderCombos(currentLayer);
    updateComboList();
}

/**
 * Delete a combo from the current layer
 * @param {number} comboIndex - Index in combos array
 */
function deleteCombo(comboIndex) {
    layouts[currentLayer].combos.splice(comboIndex, 1);
    saveToLocalStorage();
    renderCombos(currentLayer);
    updateComboList();
}

/**
 * Update the combo list display in sidebar
 */
function updateComboList() {
    const listEl = document.getElementById('combo-list');
    const combos = layouts[currentLayer].combos || [];

    if (combos.length === 0) {
        listEl.innerHTML = '<div class="combo-list-empty">No combos defined</div>';
        return;
    }

    listEl.innerHTML = combos.map((combo, idx) => {
        const key1 = combo.keys[0];
        const key2 = combo.keys[1];
        const key1Label = getKeyLabel(key1.side, key1.index);
        const key2Label = getKeyLabel(key2.side, key2.index);
        return `
            <div class="combo-list-item">
                <span class="combo-keys">${key1Label} + ${key2Label}</span>
                <span class="combo-output">${combo.output}</span>
                <button class="combo-delete" data-index="${idx}" title="Delete combo">×</button>
            </div>
        `;
    }).join('');

    // Add delete handlers
    listEl.querySelectorAll('.combo-delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const idx = parseInt(e.target.dataset.index);
            if (confirm('Delete this combo?')) {
                deleteCombo(idx);
            }
        });
    });
}

/**
 * Get a display label for a key position
 * @param {string} side - 'left' or 'right'
 * @param {number} index - Key index
 * @returns {string} Display label
 */
function getKeyLabel(side, index) {
    const keyData = layouts[currentLayer][side][index];
    if (keyData && keyData.primary) {
        return keyData.primary;
    }
    return `${side[0].toUpperCase()}${index}`;
}
```
  </action>
  <verify>Console: typeof enterComboMode === 'function' && typeof exitComboMode === 'function'</verify>
  <done>Combo mode functions implemented</done>
</task>

<task type="auto">
  <name>Task 4: Wire up event listeners and keyboard shortcuts</name>
  <files>app.js</files>
  <action>
1. Modify the key click handler in createKey() to check combo mode first.
   Find the click handler (around line 495) and update:

```javascript
    // Add click handler for selection
    key.addEventListener('click', (e) => {
        if (keyData.transparent) return;

        // Check combo mode first
        if (comboMode) {
            e.stopPropagation();
            handleComboModeClick(side, index);
            return;
        }

        selectKey(layer, side, index);
    });
```

2. Add combo button listeners in initSidebarListeners() (at the end):

```javascript
    // Combo mode buttons
    document.getElementById('btn-add-combo').addEventListener('click', enterComboMode);
    document.getElementById('btn-cancel-combo').addEventListener('click', exitComboMode);
```

3. Add ESC key handler and click-outside in initEventListeners():
   In the keydown handler, add ESC handling:

```javascript
        // ESC to exit combo mode
        if (e.key === 'Escape' && comboMode) {
            exitComboMode();
            return;
        }
```

4. Add click-outside handler for keyboard container:

```javascript
    // Click outside keyboard exits combo mode
    document.addEventListener('click', (e) => {
        if (comboMode && !e.target.closest('#keyboard-container') && !e.target.closest('#combo-mode-status')) {
            exitComboMode();
        }
    });
```

5. Call updateComboList() in renderLayout() after renderCombos():

```javascript
    requestAnimationFrame(() => {
        setZoom(currentZoom);
        renderCombos(layer);
        updateComboList();
    });
```
  </action>
  <verify>Click Add Combo button, click two keys, enter output - combo appears. ESC cancels. Click outside cancels.</verify>
  <done>Event listeners wired for combo creation flow</done>
</task>

<task type="auto">
  <name>Task 5: Export new functions and final testing</name>
  <files>app.js</files>
  <action>
Add to window.keyboardEditor exports:

```javascript
    // Combo editing (Phase 8)
    enterComboMode,
    exitComboMode,
    addCombo,
    deleteCombo,
    updateComboList
```
  </action>
  <verify>
Full workflow test:
1. Click "Add Combo" - mode activates, keys dim
2. Click first key - highlights green
3. Click second key - prompt appears
4. Enter output - combo created, appears in list
5. Click × on combo - delete confirmation, combo removed
6. Test ESC exits mode
7. Test click outside exits mode
8. Switch layers - combo list updates
  </verify>
  <done>Functions exported, full workflow verified</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] "Add Combo" button visible in sidebar
- [ ] Clicking button enters combo mode (keys dim)
- [ ] First key click highlights green
- [ ] Second key click prompts for output
- [ ] Same key click rejected
- [ ] Combo saved and rendered
- [ ] Combo list shows in sidebar
- [ ] Delete button removes combo with confirmation
- [ ] ESC exits combo mode
- [ ] Click outside keyboard exits combo mode
- [ ] Layer switch updates combo list
- [ ] Combos persist (reload page, combos still there)
- [ ] No JavaScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Complete combo creation workflow functional
- Combo list display accurate
- Delete functionality works
- Exit methods (ESC, click outside, Cancel) all work
- Existing functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/08-combo-editing/08-01-SUMMARY.md`:

# Phase 8 Plan 1: Combo Editing Summary

**[One-line summary of what was accomplished]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `index.html` - Description of changes
- `styles.css` - Description of changes
- `app.js` - Description of changes

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
v1.1 Milestone complete! Update MILESTONES.md and consider next milestone.
</output>
