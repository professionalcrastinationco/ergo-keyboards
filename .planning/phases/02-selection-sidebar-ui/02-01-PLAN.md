# Plan 02-01: Selection & Sidebar UI

## Objective
Build the sidebar editor panel and implement key selection. Users can click any key to select it and see its properties displayed in the sidebar. This creates the visual foundation for editing.

## Context
- Data layer complete: `layouts.json`, `app.js`, `styles.css` separated
- `updateKey(layer, side, index)` function ready for single-key updates
- `.key.selected` CSS class already defined in styles.css (line 187-190)
- `window.keyboardEditor` API exposed for debugging
- Key data model: `{primary, secondary, hold, transparent, accent, highlight}`

## Tasks

### Task 1: Add sidebar HTML structure
**Goal:** Create the sidebar panel in index.html

**Steps:**
1. Add sidebar container to index.html after `.keyboard-wrapper`
2. Structure: sidebar header, key info section, property fields
3. Fields needed: primary (text input), secondary (text input), hold (text input), accent (checkbox), highlight (checkbox)
4. Add "No key selected" placeholder state
5. Keep sidebar fixed width (280px) on right side

**HTML structure:**
```html
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h2>Key Editor</h2>
        <span class="selected-position" id="selected-position">No key selected</span>
    </div>
    <div class="sidebar-content" id="sidebar-content">
        <div class="no-selection" id="no-selection">
            <p>Click a key to edit</p>
        </div>
        <div class="key-fields" id="key-fields" style="display: none;">
            <div class="field-group">
                <label for="field-primary">Primary Label</label>
                <input type="text" id="field-primary" placeholder="e.g., A, Tab, Enter">
            </div>
            <div class="field-group">
                <label for="field-secondary">Secondary Label</label>
                <input type="text" id="field-secondary" placeholder="e.g., shift symbol">
            </div>
            <div class="field-group">
                <label for="field-hold">Hold Modifier</label>
                <input type="text" id="field-hold" placeholder="e.g., Shift, Ctrl, L1">
            </div>
            <div class="field-group checkbox-group">
                <label>
                    <input type="checkbox" id="field-accent">
                    Accent (red background)
                </label>
            </div>
            <div class="field-group checkbox-group">
                <label>
                    <input type="checkbox" id="field-highlight">
                    Highlight (red border)
                </label>
            </div>
        </div>
    </div>
</aside>
```

**Verification:**
- Sidebar visible on page
- All fields present
- "No key selected" shows initially

---

### Task 2: Add sidebar CSS styles
**Goal:** Style the sidebar to match existing dark theme

**Steps:**
1. Add sidebar positioning (fixed right, full height)
2. Style header and position indicator
3. Style input fields and checkboxes
4. Style placeholder state
5. Add responsive behavior (collapse on small screens)
6. Adjust main container to account for sidebar width

**CSS additions:**
```css
/* Sidebar Layout */
body {
    display: flex;
}

.container {
    flex: 1;
    max-width: calc(100% - 300px);
}

.sidebar {
    width: 280px;
    background: #1e1e36;
    border-left: 1px solid #3d3d5c;
    padding: 20px;
    display: flex;
    flex-direction: column;
    position: fixed;
    right: 0;
    top: 0;
    bottom: 0;
    overflow-y: auto;
}

.sidebar-header h2 {
    color: #fff;
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 8px;
}

.selected-position {
    color: #666;
    font-size: 12px;
}

.no-selection {
    color: #666;
    text-align: center;
    padding: 40px 0;
}

.field-group {
    margin-bottom: 16px;
}

.field-group label {
    display: block;
    color: #aaa;
    font-size: 12px;
    margin-bottom: 6px;
}

.field-group input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    background: #2d2d44;
    border: 1px solid #3d3d5c;
    border-radius: 6px;
    color: #fff;
    font-size: 14px;
}

.field-group input[type="text"]:focus {
    outline: none;
    border-color: #4a9eff;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #4a9eff;
}

@media (max-width: 1100px) {
    .sidebar {
        position: relative;
        width: 100%;
        border-left: none;
        border-top: 1px solid #3d3d5c;
    }

    body {
        flex-direction: column;
    }

    .container {
        max-width: 100%;
    }
}
```

**Verification:**
- Sidebar visually matches theme
- Input fields styled correctly
- Responsive collapse works below 1100px

---

### Task 3: Implement key selection in app.js
**Goal:** Click a key to select it and store selection state

**Steps:**
1. Add selection state: `let selectedKey = null; // {layer, side, index}`
2. Add click handler to keys in `createKey()` function
3. On click: deselect previous, select new, update state
4. Toggle `.selected` class on key element
5. Expose selection in `window.keyboardEditor` API

**JavaScript additions:**
```javascript
// Selection state
let selectedKey = null; // {layer, side, index}

// In createKey() - add click handler after existing mousedown/up handlers:
key.addEventListener('click', () => {
    if (keyData.transparent) return; // Can't select transparent keys
    selectKey(layer, side, index);
});

function selectKey(layer, side, index) {
    // Deselect previous
    if (selectedKey) {
        const prevEl = getKeyElement(selectedKey.layer, selectedKey.side, selectedKey.index);
        if (prevEl) prevEl.classList.remove('selected');
    }

    // Select new
    selectedKey = { layer, side, index };
    const newEl = getKeyElement(layer, side, index);
    if (newEl) newEl.classList.add('selected');

    // Update sidebar
    updateSidebar();
}

function deselectKey() {
    if (selectedKey) {
        const el = getKeyElement(selectedKey.layer, selectedKey.side, selectedKey.index);
        if (el) el.classList.remove('selected');
        selectedKey = null;
        updateSidebar();
    }
}

// Add to window.keyboardEditor:
window.keyboardEditor = {
    // ... existing
    selectedKey: () => selectedKey,
    selectKey,
    deselectKey
};
```

**Verification:**
- Clicking a key highlights it with blue border
- Clicking another key moves selection
- Previous key loses highlight
- Console: `keyboardEditor.selectedKey()` returns selection object

---

### Task 4: Display selected key properties in sidebar
**Goal:** When a key is selected, populate sidebar fields with its data

**Steps:**
1. Create `updateSidebar()` function
2. If no selection: show "No key selected" placeholder
3. If selection: show field group, populate values from `layouts` data
4. Update position indicator (e.g., "Base / Left / 5")
5. Handle empty/undefined values gracefully

**JavaScript additions:**
```javascript
function updateSidebar() {
    const noSelection = document.getElementById('no-selection');
    const keyFields = document.getElementById('key-fields');
    const position = document.getElementById('selected-position');

    if (!selectedKey) {
        noSelection.style.display = 'block';
        keyFields.style.display = 'none';
        position.textContent = 'No key selected';
        return;
    }

    noSelection.style.display = 'none';
    keyFields.style.display = 'block';

    const { layer, side, index } = selectedKey;
    const keyData = layouts[layer][side][index];

    // Update position indicator
    position.textContent = `${layer} / ${side} / ${index}`;

    // Populate fields
    document.getElementById('field-primary').value = keyData.primary || '';
    document.getElementById('field-secondary').value = keyData.secondary || '';
    document.getElementById('field-hold').value = keyData.hold || '';
    document.getElementById('field-accent').checked = keyData.accent || false;
    document.getElementById('field-highlight').checked = keyData.highlight || false;
}
```

**Verification:**
- Click key -> sidebar shows its properties
- Primary, secondary, hold fields show correct values
- Accent/highlight checkboxes reflect key state
- Position shows layer/side/index
- Click different key -> sidebar updates

---

### Task 5: Handle layer switching with selection
**Goal:** Preserve/clear selection appropriately when switching layers

**Steps:**
1. When layer changes, clear current selection
2. Call `deselectKey()` at start of `renderLayout()`
3. Ensure sidebar resets to "No key selected"
4. Selection only valid within current layer

**JavaScript changes:**
```javascript
function renderLayout(layer) {
    // Clear selection when changing layers
    deselectKey();

    // ... rest of existing renderLayout code
}
```

**Verification:**
- Select key on Base layer
- Switch to NavNum layer -> selection cleared
- Sidebar shows "No key selected"
- Switch back to Base -> previous key not selected

---

## Success Criteria

- [ ] Sidebar panel visible on right side (280px wide)
- [ ] Sidebar styled to match dark theme
- [ ] Clicking any non-transparent key selects it (blue border/glow)
- [ ] Only one key selected at a time
- [ ] Selected key's properties display in sidebar fields
- [ ] Position indicator shows layer/side/index
- [ ] Switching layers clears selection
- [ ] Responsive: sidebar moves below keyboard on narrow screens
- [ ] No console errors
- [ ] `window.keyboardEditor.selectedKey()` works in console

## Files Modified

- `index.html` - Add sidebar HTML structure
- `styles.css` - Add sidebar and layout styles
- `app.js` - Add selection logic and sidebar updates

## Notes

- This phase is read-only - fields display data but don't save changes yet
- Phase 3 will add input handlers to make fields editable
- Selection state stored in memory, not persisted
- Sidebar fields are intentionally disabled/read-only visually until Phase 3
